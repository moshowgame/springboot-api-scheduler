<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.software.dev.mapper.ApiResponseMapper">
    
    <resultMap id="ApiResponseResult" type="com.software.dev.entity.ApiResponse">
        <id property="id" column="id"/>
        <result property="taskId" column="task_id"/>
        <result property="requestUrl" column="request_url"/>
        <result property="requestMethod" column="request_method"/>
        <result property="requestHeaders" column="request_headers"/>
        <result property="requestParams" column="request_params"/>
        <result property="responseCode" column="response_code"/>
        <result property="responseBody" column="response_body"/>
        <result property="responseTime" column="response_time"/>
        <result property="status" column="status"/>
        <result property="errorMessage" column="error_message"/>
        <result property="executeTime" column="execute_time"/>
        <result property="assertionResult" column="assertion_result"/>
        <result property="allAssertionsPassed" column="all_assertions_passed"/>
    </resultMap>

    <select id="findByTaskId" parameterType="String" resultMap="ApiResponseResult">
        SELECT * FROM api_response WHERE task_id = #{taskId} ORDER BY execute_time DESC
    </select>

    <select id="findByTaskIdWithTimeRange" resultMap="ApiResponseResult">
        SELECT * FROM api_response 
        WHERE task_id = #{taskId}
        <if test="startTime != null and startTime != ''">
            AND execute_time &gt;= #{startTime}::timestamp
        </if>
        <if test="endTime != null and endTime != ''">
            AND execute_time &lt;= #{endTime}::timestamp
        </if>
        ORDER BY execute_time DESC
    </select>

    <select id="findAll" resultMap="ApiResponseResult">
        SELECT * FROM api_response ORDER BY execute_time DESC
    </select>

    <!-- 新增统一处理所有条件的方法 -->
    <select id="findByPageWithConditions" resultMap="ApiResponseResult">
        SELECT * FROM api_response
        <where>
            <if test="taskId != null and taskId != ''">
                task_id = #{taskId}
            </if>
            <if test="startTime != null and startTime != ''">
                <if test="taskId != null and taskId != ''">
                    AND
                </if>
                execute_time &gt;= #{startTime}::timestamp
            </if>
            <if test="endTime != null and endTime != ''">
                <if test="(taskId != null and taskId != '') or (startTime != null and startTime != '')">
                    AND
                </if>
                execute_time &lt;= #{endTime}::timestamp
            </if>
        </where>
        ORDER BY execute_time DESC LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="count" resultType="int">
        SELECT COUNT(*) FROM api_response
    </select>

    <!-- 新增统一计数方法 -->
    <select id="countByConditions" resultType="int">
        SELECT COUNT(*) FROM api_response
        <where>
            <if test="taskId != null and taskId != ''">
                task_id = #{taskId}
            </if>
            <if test="startTime != null and startTime != ''">
                <if test="taskId != null and taskId != ''">
                    AND
                </if>
                execute_time &gt;= #{startTime}::timestamp
            </if>
            <if test="endTime != null and endTime != ''">
                <if test="(taskId != null and taskId != '') or (startTime != null and startTime != '')">
                    AND
                </if>
                execute_time &lt;= #{endTime}::timestamp
            </if>
        </where>
    </select>

    <insert id="insert" parameterType="com.software.dev.entity.ApiResponse">
        INSERT INTO api_response (id, task_id, request_url, request_method, request_headers, request_params, 
                                 response_code, response_body, response_time, status, error_message, execute_time, 
                                 assertion_result, all_assertions_passed)
        VALUES (#{id}, #{taskId}, #{requestUrl}, #{requestMethod}, #{requestHeaders}, #{requestParams}, 
                #{responseCode}, #{responseBody}, #{responseTime}, #{status}, #{errorMessage}, #{executeTime}, 
                #{assertionResult}, #{allAssertionsPassed})
    </insert>
    
    <select id="selectByTaskIdAndTimeRange" resultMap="ApiResponseResult">
        SELECT * FROM api_response 
        WHERE task_id = #{taskId} 
          AND execute_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY execute_time DESC
    </select>

</mapper>