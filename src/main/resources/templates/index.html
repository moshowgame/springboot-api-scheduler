<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app" class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">ğŸš€ SpringBoot-API-Scheduler</a>
                <div class="navbar-nav me-auto">
                    <a class="nav-link" href="#" @click="showTasks">ğŸ“‹ ä»»åŠ¡ç®¡ç†</a>
                    <a class="nav-link" href="#" @click="showLogs">ğŸ“Š æ‰§è¡Œæ—¥å¿—</a>
                </div>
                <div class="navbar-nav">
                    <span class="navbar-text me-3">ğŸ‘¤ {{ currentUser }}</span>
                    <a class="nav-link" href="#" @click="logout">ğŸšª é€€å‡º</a>
                </div>
            </div>
        </nav>

        <!-- ä»»åŠ¡ç®¡ç†é¡µé¢ -->
        <div v-if="currentView === 'tasks'" class="mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>APIä»»åŠ¡ç®¡ç†</h5>
                                <div>
                                    <button class="btn btn-warning me-2" @click="showAlertConfigModal">
                                        <i class="bi bi-bell"></i> è­¦æŠ¥é…ç½®
                                    </button>
                                    <button class="btn btn-primary" @click="showAddTaskModal">æ·»åŠ ä»»åŠ¡</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="d-flex align-items-center">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" id="selectAllTasks" 
                                               @change="toggleSelectAll" :checked="allTasksSelected">
                                        <label class="form-check-label" for="selectAllTasks">
                                            å…¨é€‰
                                        </label>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                @click="batchStartTasks" :disabled="!selectedTasks || selectedTasks.length === 0">
                                            æ‰¹é‡å¯åŠ¨
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                                @click="batchPauseTasks" :disabled="!selectedTasks || selectedTasks.length === 0">
                                            æ‰¹é‡æš‚åœ
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                @click="batchEnableAlerts" :disabled="!selectedTasks || selectedTasks.length === 0">
                                            å¯ç”¨è­¦æŠ¥
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                @click="batchDisableAlerts" :disabled="!selectedTasks || selectedTasks.length === 0">
                                            ç¦ç”¨è­¦æŠ¥
                                        </button>
                                    </div>
                                    <span class="ms-3 text-muted" v-if="selectedTasks && selectedTasks.length > 0">
                                        å·²é€‰æ‹© {{ selectedTasks.length }} ä¸ªä»»åŠ¡
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">é€‰æ‹©</th>
                                        <th>ID</th>
                                        <th>ä»»åŠ¡åç§°</th>
                                        <th>URL</th>
                                        <th>æ–¹æ³•</th>
                                        <th>Cronè¡¨è¾¾å¼</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è­¦æŠ¥</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="task in tasks" :key="task.id">
                                        <td>
                                            <input class="form-check-input" type="checkbox" 
                                                   :value="task.id" v-model="selectedTasks">
                                        </td>
                                        <td>{{ task.id }}</td>
                                        <td>{{ task.taskName }}</td>
                                        <td>{{ task.url }}</td>
                                        <td>{{ task.method }}</td>
                                        <td>{{ task.cronExpression }}</td>
                                        <td>
                                            <span :class="getStatusClass(task.status)">{{ task.status }}</span>
                                        </td>
                                        <td>
                                            <span v-if="task.alertEnabled" class="badge bg-success">å·²å¯ç”¨</span>
                                            <span v-else class="badge bg-secondary">å·²ç¦ç”¨</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success" @click="startTask(task.id)" v-if="task.status === 'PAUSED'">å¯åŠ¨</button>
                                            <button class="btn btn-sm btn-warning" @click="pauseTask(task.id)" v-if="task.status === 'RUNNING'">æš‚åœ</button>
                                            <button class="btn btn-sm btn-info" @click="executeTask(task.id)">æ‰§è¡Œ</button>
                                            <button class="btn btn-sm btn-primary" @click="configAssertions(task)">æ–­è¨€</button>
                                            <button class="btn btn-sm btn-outline-info" @click="viewTaskLogs(task.id)">æ—¥å¿—</button>
                                            <button class="btn btn-sm btn-outline-secondary" @click="copyTask(task)">å¤åˆ¶</button>
                                            <button class="btn btn-sm btn-secondary" @click="editTask(task)">ç¼–è¾‘</button>
                                            <button class="btn btn-sm btn-danger" @click="deleteTask(task.id)">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰§è¡Œæ—¥å¿—é¡µé¢ -->
        <div v-if="currentView === 'logs'" class="mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>æ‰§è¡Œæ—¥å¿—</h5>
                                <div class="d-flex align-items-center">
                                    <select class="form-select me-2" style="width: 300px;" v-model="selectedTaskId" @change="filterLogsByTask">
                                        <option value="">æ‰€æœ‰ä»»åŠ¡</option>
                                        <option v-for="task in allTasks" :key="task.id" :value="task.id">
                                            {{ task.taskName }} ({{ task.url }})
                                        </option>
                                    </select>
                                    <button class="btn btn-outline-secondary btn-sm" @click="clearLogFilter">æ¸…é™¤ç­›é€‰</button>
                                </div>
                            </div>
                            <div v-if="selectedTaskId" class="alert alert-info mb-0 py-2">
                                <small>
                                    <strong>å½“å‰ç­›é€‰ï¼š</strong>
                                    {{ getSelectedTaskName() }}
                                    <span class="ms-2">å…± {{ filteredLogs.length }} æ¡è®°å½•</span>
                                </small>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ä»»åŠ¡ID</th>
                                        <th>è¯·æ±‚URL</th>
                                        <th>æ–¹æ³•</th>
                                        <th>å“åº”ç </th>
                                        <th>å“åº”æ—¶é—´(ms)</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ–­è¨€ç»“æœ</th>
                                        <th>æ‰§è¡Œæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="log in filteredLogs" :key="log.id">
                                        <td>{{ log.id }}</td>
                                        <td>{{ log.taskId }}</td>
                                        <td>{{ log.requestUrl }}</td>
                                        <td>{{ log.requestMethod }}</td>
                                        <td>{{ log.responseCode }}</td>
                                        <td>{{ log.responseTime }}</td>
                                        <td>
                                            <span :class="getStatusClass(log.status)">{{ log.status }}</span>
                                        </td>
                                        <td style="max-width: 250px;">
                                            <div v-if="log.assertionResult" :class="getAssertionClass(log.allAssertionsPassed)">
                                                <div v-if="log.assertionResult.length <= 50" 
                                                     style="word-break: break-all; line-height: 1.4;">
                                                    {{ log.assertionResult }}
                                                </div>
                                                <div v-else>
                                                    <div v-if="!log.expandedAssertion" 
                                                         style="word-break: break-all; line-height: 1.4;">
                                                        {{ log.assertionResult.substring(0, 50) }}...
                                                        <a href="#" @click.prevent="toggleAssertionExpanded(log)" 
                                                           class="text-decoration-none ms-1">
                                                            <small>å±•å¼€</small>
                                                        </a>
                                                    </div>
                                                    <div v-else 
                                                         style="word-break: break-all; line-height: 1.4;">
                                                        {{ log.assertionResult }}
                                                        <a href="#" @click.prevent="toggleAssertionExpanded(log)" 
                                                           class="text-decoration-none ms-1">
                                                            <small>æ”¶èµ·</small>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            <span v-else class="text-muted">æ— æ–­è¨€</span>
                                        </td>
                                        <td>{{ formatDateTime(log.executeTime) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info" @click="viewLogDetail(log)">è¯¦æƒ…</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
        <div class="modal fade" id="taskModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ editingTask ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ·»åŠ ä»»åŠ¡' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">ä»»åŠ¡åç§°</label>
                                <input type="text" class="form-control" v-model="currentTask.taskName">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">URL</label>
                                <input type="text" class="form-control" v-model="currentTask.url">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æ–¹æ³•</label>
                                <select class="form-select" v-model="currentTask.method">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¶…æ—¶æ—¶é—´(ms)</label>
                                <input type="number" class="form-control" v-model="currentTask.timeout">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cronè¡¨è¾¾å¼</label>
                                <input type="text" class="form-control" v-model="currentTask.cronExpression" 
                                       placeholder="ä¾‹å¦‚: 0 */5 * * * ? (æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡)">
                                <div class="mt-2">
                                    <small class="text-muted">å¸¸ç”¨Cronè¡¨è¾¾å¼ç¤ºä¾‹ï¼š</small>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */1 * * * ?')">æ¯1åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */5 * * * ?')">æ¯5åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */10 * * * ?')">æ¯10åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */30 * * * ?')">æ¯30åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 0 * * * ?')">æ¯å°æ—¶</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 0 */2 * * ?')">æ¯2å°æ—¶</button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 0 0 * * ?')">æ¯å¤©å‡Œæ™¨</button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 30 8 * * ?')">æ¯å¤©8:30</button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 0 9 * * MON')">æ¯å‘¨ä¸€9ç‚¹</button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 0 1 * * ?')">æ¯æœˆ1å·</button>
                                            <button type="button" class="btn btn-sm btn-outline-info me-1 mb-1" 
                                                    @click="setCronExpression('0 0 9 ? * MON-FRI')">å·¥ä½œæ—¥9ç‚¹</button>
                                            <button type="button" class="btn btn-sm btn-outline-info me-1 mb-1" 
                                                    @click="setCronExpression('0 0 10 ? * SAT,SUN')">å‘¨æœ«10ç‚¹</button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">æ ¼å¼è¯´æ˜ï¼šç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨ [å¹´]</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Headers (JSONæ ¼å¼)</label>
                                <textarea class="form-control" v-model="currentTask.headers" rows="3"
                                          placeholder='{"Content-Type": "application/json"}'></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Parameters (JSONæ ¼å¼)</label>
                                <textarea class="form-control" v-model="currentTask.parameters" rows="3"
                                          placeholder='{"key": "value"}'></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" v-model="currentTask.description" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" @click="saveTask">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div class="modal fade" id="logDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ—¥å¿—è¯¦æƒ…</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="currentLog">
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚URL</label>
                                <input type="text" class="form-control" :value="currentLog.requestUrl" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚æ–¹æ³•</label>
                                <input type="text" class="form-control" :value="currentLog.requestMethod" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚Headers</label>
                                <textarea class="form-control" v-model="currentLog.requestHeaders" rows="3" readonly></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚å‚æ•°</label>
                                <textarea class="form-control" v-model="currentLog.requestParams" rows="3" readonly></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å“åº”ç </label>
                                <input type="text" class="form-control" :value="currentLog.responseCode" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å“åº”ä½“</label>
                                <textarea class="form-control" v-model="currentLog.responseBody" rows="10" readonly></textarea>
                            </div>
                            <div v-if="currentLog.errorMessage" class="mb-3">
                                <label class="form-label">é”™è¯¯ä¿¡æ¯</label>
                                <textarea class="form-control" v-model="currentLog.errorMessage" rows="3" readonly></textarea>
                            </div>
                            <div v-if="currentLog.assertionResult" class="mb-3">
                                <label class="form-label">æ–­è¨€ç»“æœ</label>
                                <div class="alert" :class="currentLog.allAssertionsPassed ? 'alert-success' : 'alert-danger'">
                                    {{ currentLog.assertionResult }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–­è¨€é…ç½®æ¨¡æ€æ¡† -->
        <div class="modal fade" id="assertionConfigModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ–­è¨€é…ç½® - {{ currentConfigTask.taskName || 'æœªçŸ¥ä»»åŠ¡' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6 class="mb-3">æ–­è¨€è§„åˆ™</h6>
                            
                            <div class="card">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <label class="form-label">æ–­è¨€ç±»å‹</label>
                                            <select class="form-select" v-model="currentAssertion.assertionType">
                                                <option value="">é€‰æ‹©ç±»å‹</option>
                                                <option value="HTTP_CODE">HTTPçŠ¶æ€ç </option>
                                                <option value="JSON_CONTAINS">JSONåŒ…å«å…³é”®å­—</option>
                                                <option value="JSON_PATH">JSONè·¯å¾„</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">æœŸæœ›å€¼</label>
                                            <input type="text" class="form-control" 
                                                   v-model="currentAssertion.expectedValue" 
                                                   :placeholder="getAssertionPlaceholder(currentAssertion.assertionType)">
                                        </div>
                                        <div class="col-md-3">
                                        </div>
                                    </div>
                                    <div v-if="currentAssertion.assertionType" class="mt-3">
                                        <div class="alert alert-info">
                                            <h6 class="alert-heading">{{ getAssertionTitle(currentAssertion.assertionType) }}</h6>
                                            <div class="mb-2">{{ getAssertionDescription(currentAssertion.assertionType) }}</div>
                                            <div class="mt-2">
                                                <strong>ç¤ºä¾‹ï¼š</strong>
                                                <div class="mt-1 p-2 bg-light rounded">
                                                    <code>{{ getAssertionExample(currentAssertion.assertionType) }}</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" @click="saveAssertions">ä¿å­˜æ–­è¨€</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è­¦æŠ¥é…ç½®æ¨¡æ€æ¡† -->
        <div class="modal fade" id="alertConfigModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">é”™è¯¯è­¦æŠ¥é…ç½®</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">è­¦æŠ¥åŠŸèƒ½è¯´æ˜</h6>
                            <p>å½“ä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´å†…çš„æ–­è¨€å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å‘é€HTTPè¯·æ±‚åˆ°æ‚¨é…ç½®çš„APIåœ°å€ã€‚</p>
                            <ul>
                                <li>æ—¶é—´çª—å£ï¼šæ£€æŸ¥è¿‡å»1å°æ—¶å†…çš„æ‰§è¡Œè®°å½•</li>
                                <li>å¤±è´¥ç‡è®¡ç®—ï¼šå¤±è´¥æ¬¡æ•° / æ€»æ‰§è¡Œæ¬¡æ•° Ã— 100%</li>
                                <li>è§¦å‘æ¡ä»¶ï¼šå¤±è´¥ç‡è¶…è¿‡è®¾å®šçš„é˜ˆå€¼</li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å¤±è´¥ç‡é˜ˆå€¼ (%)</label>
                                    <input type="number" class="form-control" v-model="alertConfig.failureRateThreshold" 
                                           min="1" max="100" placeholder="ä¾‹å¦‚: 50">
                                    <div class="form-text">å½“å¤±è´¥ç‡è¶…è¿‡æ­¤å€¼æ—¶è§¦å‘è­¦æŠ¥</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ£€æŸ¥é—´éš” (åˆ†é’Ÿ)</label>
                                    <input type="number" class="form-control" v-model="alertConfig.checkInterval" 
                                           min="5" max="1440" placeholder="ä¾‹å¦‚: 30">
                                    <div class="form-text">ç³»ç»Ÿæ£€æŸ¥è­¦æŠ¥çš„é¢‘ç‡</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">è­¦æŠ¥APIåœ°å€</label>
                            <input type="text" class="form-control" v-model="alertConfig.apiUrl" 
                                   placeholder="ä¾‹å¦‚: https://api.example.com/alert">
                            <div class="form-text">è­¦æŠ¥è§¦å‘æ—¶è°ƒç”¨çš„APIåœ°å€</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è¯·æ±‚æ–¹æ³•</label>
                                    <select class="form-select" v-model="alertConfig.httpMethod">
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è¯·æ±‚å¤´ (JSONæ ¼å¼)</label>
                                    <textarea class="form-control" v-model="alertConfig.headers" rows="2"
                                              placeholder='{"Content-Type": "application/json"}'></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">è¯·æ±‚ä½“ (JSONæ ¼å¼)</label>
                            <textarea class="form-control" v-model="alertConfig.body" rows="3"
                                      placeholder='{"message": "APIä»»åŠ¡æ–­è¨€å¤±è´¥ç‡è¿‡é«˜", "taskId": "${taskId}", "failureRate": "${failureRate}%"}'></textarea>
                            <div class="form-text">å¯ä½¿ç”¨å˜é‡: ${taskId}, ${taskName}, ${failureRate}, ${failureCount}, ${totalCount}</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" v-model="alertConfig.enabled">
                                <label class="form-check-label">å¯ç”¨è­¦æŠ¥åŠŸèƒ½</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" @click="saveAlertConfig">ä¿å­˜é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentView: 'tasks',
                    tasks: [],
                    logs: [],
                    allTasks: [], // ç”¨äºæ—¥å¿—ç­›é€‰çš„ä»»åŠ¡åˆ—è¡¨
                    filteredLogs: [], // ç­›é€‰åçš„æ—¥å¿—
                    selectedTaskId: '', // å½“å‰é€‰ä¸­çš„ä»»åŠ¡ID
                    selectedTasks: [], // æ‰¹é‡é€‰ä¸­çš„ä»»åŠ¡IDåˆ—è¡¨
                    currentTask: {},
                    currentLog: {},
                    currentAssertion: {
                        assertionType: 'HTTP_CODE',
                        expectedValue: ''
                    },
                    currentConfigTask: {},
                    editingTask: false,
                    // è­¦æŠ¥é…ç½®ç›¸å…³
                    alertConfig: {
                        failureRateThreshold: 50, // å¤±è´¥ç‡é˜ˆå€¼(%)
                        checkInterval: 30, // æ£€æŸ¥é—´éš”(åˆ†é’Ÿ)
                        apiUrl: '', // è­¦æŠ¥APIåœ°å€
                        httpMethod: 'POST', // è¯·æ±‚æ–¹æ³•
                        headers: '{"Content-Type": "application/json"}', // è¯·æ±‚å¤´
                        body: '{"message": "APIä»»åŠ¡æ–­è¨€å¤±è´¥ç‡è¿‡é«˜", "taskId": "${taskId}", "taskName": "${taskName}", "failureRate": "${failureRate}%"}', // è¯·æ±‚ä½“
                        enabled: false // æ˜¯å¦å¯ç”¨
                    },
                    taskModal: null,
                    logDetailModal: null,
                    assertionConfigModal: null,
                    alertConfigModal: null,
                    currentUser: ''
                };
            },
            mounted() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                this.checkAuth();
                
                this.taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                this.logDetailModal = new bootstrap.Modal(document.getElementById('logDetailModal'));
                this.assertionConfigModal = new bootstrap.Modal(document.getElementById('assertionConfigModal'));
                this.alertConfigModal = new bootstrap.Modal(document.getElementById('alertConfigModal'));
                this.loadTasks();
                this.loadLogs();
            },
            methods: {
                showTasks() {
                    this.currentView = 'tasks';
                },
                showLogs() {
                    this.currentView = 'logs';
                    this.loadLogs();
                },
                async loadTasks() {
                    try {
                        const response = await axios.get('/api/tasks');
                        this.tasks = (response.data && response.data.data) ? response.data.data : [];
                        this.allTasks = [...this.tasks]; // å¤åˆ¶ä»»åŠ¡åˆ—è¡¨ç”¨äºç­›é€‰
                    } catch (error) {
                        console.error('Failed to load tasks:', error);
                        this.tasks = [];
                        this.allTasks = [];
                    }
                },
                async loadLogs() {
                    try {
                        const response = await axios.get('/api/responses');
                        this.logs = (response.data && response.data.data) ? response.data.data : [];
                        this.filteredLogs = [...this.logs]; // åˆå§‹åŒ–ç­›é€‰åçš„æ—¥å¿—
                    } catch (error) {
                        console.error('Failed to load logs:', error);
                        this.logs = [];
                        this.filteredLogs = [];
                    }
                },
                // æ—¥å¿—ç­›é€‰ç›¸å…³æ–¹æ³•
                async filterLogsByTask() {
                    if (this.selectedTaskId) {
                        await this.loadTaskLogs(this.selectedTaskId);
                    } else {
                        this.filteredLogs = [...this.logs];
                    }
                },
                async loadTaskLogs(taskId) {
                    try {
                        const response = await axios.get(`/api/responses/task/${taskId}`);
                        this.filteredLogs = (response.data && response.data.data) ? response.data.data : [];
                    } catch (error) {
                        console.error('Failed to load task logs:', error);
                        this.filteredLogs = [];
                    }
                },
                clearLogFilter() {
                    this.selectedTaskId = '';
                    this.filteredLogs = [...this.logs];
                },
                getSelectedTaskName() {
                    if (!this.selectedTaskId) return '';
                    const task = this.allTasks.find(t => t.id === this.selectedTaskId);
                    return task ? `${task.taskName} (${task.url})` : 'æœªçŸ¥ä»»åŠ¡';
                },
                async viewTaskLogs(taskId) {
                    this.selectedTaskId = taskId;
                    this.currentView = 'logs';
                    await this.loadTaskLogs(taskId);
                },
                showAddTaskModal() {
                    this.editingTask = false;
                    this.currentTask = {
                        taskName: '',
                        url: '',
                        method: 'GET',
                        timeout: 30000,
                        cronExpression: '',
                        headers: '',
                        parameters: '',
                        description: ''
                    };
                    this.taskModal.show();
                },
                async editTask(task) {
                    this.editingTask = true;
                    this.currentTask = { ...task };
                    this.taskModal.show();
                },
                copyTask(task) {
                    this.editingTask = false; // è®¾ç½®ä¸ºæ–°å¢æ¨¡å¼
                    // å¤åˆ¶ä»»åŠ¡çš„æ‰€æœ‰å±æ€§ï¼Œä½†ä¸åŒ…å«IDå’Œæ–­è¨€
                    this.currentTask = {
                        taskName: task.taskName + ' (å‰¯æœ¬)',
                        url: task.url,
                        method: task.method,
                        timeout: task.timeout,
                        cronExpression: task.cronExpression,
                        headers: task.headers,
                        parameters: task.parameters,
                        description: task.description
                    };
                    this.taskModal.show();
                },
                async saveTask() {
                    try {
                        // ä¿å­˜ä»»åŠ¡
                        if (this.editingTask) {
                            await axios.put(`/api/tasks/${this.currentTask.id}`, this.currentTask);
                        } else {
                            await axios.post('/api/tasks', this.currentTask);
                        }
                        
                        this.taskModal.hide();
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to save task:', error);
                    }
                },
                async deleteTask(id) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                        try {
                            await axios.delete(`/api/tasks/${id}`);
                            this.loadTasks();
                        } catch (error) {
                            console.error('Failed to delete task:', error);
                        }
                    }
                },
                async startTask(id) {
                    try {
                        await axios.post(`/api/tasks/${id}/start`);
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to start task:', error);
                    }
                },
                async pauseTask(id) {
                    try {
                        await axios.post(`/api/tasks/${id}/pause`);
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to pause task:', error);
                    }
                },
                async executeTask(id) {
                    try {
                        await axios.post(`/api/tasks/${id}/execute`);
                        alert('ä»»åŠ¡å·²æäº¤æ‰§è¡Œ');
                    } catch (error) {
                        console.error('Failed to execute task:', error);
                    }
                },
                viewLogDetail(log) {
                    this.currentLog = log;
                    this.logDetailModal.show();
                },
                getStatusClass(status) {
                    return {
                        'badge bg-success': status === 'RUNNING' || status === 'SUCCESS',
                        'badge bg-warning': status === 'PAUSED',
                        'badge bg-danger': status === 'ERROR'
                    };
                },
                formatDateTime(dateTime) {
                    if (!dateTime) return '';
                    return new Date(dateTime).toLocaleString();
                },
                setCronExpression(expression) {
                    this.currentTask.cronExpression = expression;
                },
                toggleAssertionExpanded(log) {
                    // Vue 3 ä¸­ç›´æ¥èµ‹å€¼å³å¯å®ç°å“åº”å¼æ›´æ–°
                    log.expandedAssertion = !log.expandedAssertion;
                },
                async checkAuth() {
                    try {
                        const response = await axios.get('/api/auth/check');
                        if (response.data.authenticated) {
                            this.currentUser = response.data.username;
                        } else {
                            window.location.href = '/login';
                        }
                    } catch (error) {
                        console.error('Auth check failed:', error);
                        window.location.href = '/login';
                    }
                },
                async logout() {
                    try {
                        await axios.post('/api/auth/logout');
                        window.location.href = '/login';
                    } catch (error) {
                        console.error('Logout failed:', error);
                        window.location.href = '/login';
                    }
                },
                // æ–­è¨€ç›¸å…³æ–¹æ³•
                async loadTaskAssertions(taskId) {
                    try {
                        const response = await axios.get(`/api/assertions/task/${taskId}`);
                        const assertions = (response.data && response.data.data) ? response.data.data : [];
                        if (assertions.length > 0) {
                            this.currentAssertion = {
                                id: assertions[0].id,
                                assertionType: assertions[0].assertionType,
                                expectedValue: assertions[0].expectedValue
                            };
                        } else {
                            this.currentAssertion = {
                                assertionType: 'HTTP_CODE',
                                expectedValue: ''
                            };
                        }
                    } catch (error) {
                        console.error('Failed to load task assertions:', error);
                        this.currentAssertion = {
                            assertionType: 'HTTP_CODE',
                            expectedValue: ''
                        };
                    }
                },

                addAssertion() {
                    // å•ä¸ªæ–­è¨€ï¼Œä¸éœ€è¦æ·»åŠ æ–¹æ³•
                },
                removeAssertion(index) {
                    // å•ä¸ªæ–­è¨€ï¼Œä¸éœ€è¦åˆ é™¤æ–¹æ³•
                },
                getAssertionPlaceholder(type) {
                    switch (type) {
                        case 'HTTP_CODE':
                            return 'ä¾‹å¦‚: 200, 500';
                        case 'JSON_CONTAINS':
                            return 'ä¾‹å¦‚: success, error';
                        case 'JSON_PATH':
                            return 'ä¾‹å¦‚: $.msg, $.data.status';
                        default:
                            return 'è¯·é€‰æ‹©æ–­è¨€ç±»å‹';
                    }
                },
                getAssertionDescription(type) {
                    switch (type) {
                        case 'HTTP_CODE':
                            return 'æ£€æŸ¥HTTPå“åº”çŠ¶æ€ç æ˜¯å¦ç­‰äºæŒ‡å®šå€¼';
                        case 'JSON_CONTAINS':
                            return 'æ£€æŸ¥å“åº”ä½“æ˜¯å¦åŒ…å«æŒ‡å®šçš„å…³é”®å­—';
                        case 'JSON_PATH':
                            return 'ä½¿ç”¨JSONPathè¡¨è¾¾å¼æ£€æŸ¥å“åº”ä½“ä¸­çš„ç‰¹å®šå­—æ®µå€¼';
                        default:
                            return '';
                    }
                },
                getAssertionTitle(type) {
                    switch (type) {
                        case 'HTTP_CODE':
                            return 'HTTPçŠ¶æ€ç æ–­è¨€';
                        case 'JSON_CONTAINS':
                            return 'JSONåŒ…å«å…³é”®å­—æ–­è¨€';
                        case 'JSON_PATH':
                            return 'JSONè·¯å¾„æ–­è¨€';
                        default:
                            return '';
                    }
                },
                getAssertionExample(type) {
                    switch (type) {
                        case 'HTTP_CODE':
                            return `æœŸæœ›å€¼: 200
ç”¨é€”: éªŒè¯APIè¯·æ±‚æˆåŠŸè¿”å›
å¸¸è§å€¼: 200(æˆåŠŸ), 400(å®¢æˆ·ç«¯é”™è¯¯), 500(æœåŠ¡å™¨é”™è¯¯)`;
                        case 'JSON_CONTAINS':
                            return `æœŸæœ›å€¼: success
ç”¨é€”: æ£€æŸ¥å“åº”ä½“ä¸­æ˜¯å¦åŒ…å«æˆåŠŸæ ‡è¯†
å…¶ä»–ç¤ºä¾‹: error, "status":"ok", "message"`;
                        case 'JSON_PATH':
                            return `æœŸæœ›å€¼: $.code
ç”¨é€”: æ£€æŸ¥JSONå“åº”ä¸­ç‰¹å®šå­—æ®µçš„å€¼
å…¶ä»–ç¤ºä¾‹: $.data.status, $.users[0].name, $.msg`;
                        default:
                            return '';
                    }
                },

                getAssertionClass(passed) {
                    return {
                        'badge bg-success': passed === true,
                        'badge bg-danger': passed === false,
                        'badge bg-secondary': passed === null || passed === undefined
                    };
                },
                // æ–­è¨€é…ç½®ç›¸å…³æ–¹æ³•
                async configAssertions(task) {
                    this.currentConfigTask = { ...task };
                    await this.loadTaskAssertions(task.id);
                    this.assertionConfigModal.show();
                },
                async saveAssertions() {
                    try {
                        if (!this.currentConfigTask || !this.currentConfigTask.id) {
                            console.error('No task selected for assertion configuration');
                            return;
                        }
                        
                        if (this.currentAssertion && this.currentAssertion.assertionType && this.currentAssertion.expectedValue) {
                            await axios.post(`/api/assertions/task/${this.currentConfigTask.id}`, this.currentAssertion);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ–­è¨€é…ç½®ï¼Œåˆ é™¤ç°æœ‰æ–­è¨€
                            await axios.delete(`/api/assertions/task/${this.currentConfigTask.id}`);
                        }
                        this.assertionConfigModal.hide();
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to save assertions:', error);
                        alert('ä¿å­˜æ–­è¨€å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    }
                },
                // è­¦æŠ¥é…ç½®ç›¸å…³æ–¹æ³•
                showAlertConfigModal() {
                    this.alertConfigModal.show();
                },
                async saveAlertConfig() {
                    try {
                        // éªŒè¯é…ç½®
                        if (!this.alertConfig.failureRateThreshold || this.alertConfig.failureRateThreshold <= 0 || this.alertConfig.failureRateThreshold > 100) {
                            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤±è´¥ç‡é˜ˆå€¼(1-100)');
                            return;
                        }
                        
                        if (!this.alertConfig.checkInterval || this.alertConfig.checkInterval < 5 || this.alertConfig.checkInterval > 1440) {
                            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ£€æŸ¥é—´éš”(5-1440åˆ†é’Ÿ)');
                            return;
                        }
                        
                        if (!this.alertConfig.apiUrl) {
                            alert('è¯·è¾“å…¥è­¦æŠ¥APIåœ°å€');
                            return;
                        }
                        
                        // ä¿å­˜é…ç½®åˆ°åç«¯
                        await axios.post('/api/alert/config', this.alertConfig);
                        
                        this.alertConfigModal.hide();
                        alert('è­¦æŠ¥é…ç½®å·²ä¿å­˜');
                    } catch (error) {
                        console.error('Failed to save alert config:', error);
                        alert('ä¿å­˜è­¦æŠ¥é…ç½®å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    }
                },
                // æ‰¹é‡æ“ä½œç›¸å…³æ–¹æ³•
                toggleSelectAll() {
                    if (this.allTasksSelected) {
                        this.selectedTasks = [];
                    } else {
                        this.selectedTasks = this.tasks.map(task => task.id);
                    }
                },
                get allTasksSelected() {
                    return this.tasks && this.tasks.length > 0 && 
                           this.selectedTasks && this.selectedTasks.length === this.tasks.length;
                },
                async batchStartTasks() {
                    try {
                        const selectedCount = this.selectedTasks.length;
                        for (const taskId of this.selectedTasks) {
                            await axios.post(`/api/tasks/${taskId}/start`);
                        }
                        this.selectedTasks = [];
                        this.loadTasks();
                        alert(`å·²å¯åŠ¨ ${selectedCount} ä¸ªä»»åŠ¡`);
                    } catch (error) {
                        console.error('Failed to start tasks:', error);
                        alert('æ‰¹é‡å¯åŠ¨ä»»åŠ¡å¤±è´¥');
                    }
                },
                async batchPauseTasks() {
                    try {
                        const selectedCount = this.selectedTasks.length;
                        for (const taskId of this.selectedTasks) {
                            await axios.post(`/api/tasks/${taskId}/pause`);
                        }
                        this.selectedTasks = [];
                        this.loadTasks();
                        alert(`å·²æš‚åœ ${selectedCount} ä¸ªä»»åŠ¡`);
                    } catch (error) {
                        console.error('Failed to pause tasks:', error);
                        alert('æ‰¹é‡æš‚åœä»»åŠ¡å¤±è´¥');
                    }
                },
                async batchEnableAlerts() {
                    try {
                        const selectedCount = this.selectedTasks.length;
                        for (const taskId of this.selectedTasks) {
                            await axios.post(`/api/alert/enable/${taskId}`);
                        }
                        this.selectedTasks = [];
                        this.loadTasks();
                        alert(`å·²ä¸º ${selectedCount} ä¸ªä»»åŠ¡å¯ç”¨è­¦æŠ¥`);
                    } catch (error) {
                        console.error('Failed to enable alerts:', error);
                        alert('æ‰¹é‡å¯ç”¨è­¦æŠ¥å¤±è´¥');
                    }
                },
                async batchDisableAlerts() {
                    try {
                        const selectedCount = this.selectedTasks.length;
                        for (const taskId of this.selectedTasks) {
                            await axios.post(`/api/alert/disable/${taskId}`);
                        }
                        this.selectedTasks = [];
                        this.loadTasks();
                        alert(`å·²ä¸º ${selectedCount} ä¸ªä»»åŠ¡ç¦ç”¨è­¦æŠ¥`);
                    } catch (error) {
                        console.error('Failed to disable alerts:', error);
                        alert('æ‰¹é‡ç¦ç”¨è­¦æŠ¥å¤±è´¥');
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>