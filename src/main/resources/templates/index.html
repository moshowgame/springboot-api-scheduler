<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app" class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">ğŸš€ SpringBoot-API-Scheduler</a>
                <div class="navbar-nav me-auto">
                    <a class="nav-link" href="#" @click="showTasks">ğŸ“‹ ä»»åŠ¡ç®¡ç†</a>
                    <a class="nav-link" href="#" @click="showLogs">ğŸ“Š æ‰§è¡Œæ—¥å¿—</a>
                </div>
                <div class="navbar-nav">
                    <span class="navbar-text me-3">ğŸ‘¤ {{ currentUser }}</span>
                    <a class="nav-link" href="#" @click="logout">ğŸšª é€€å‡º</a>
                </div>
            </div>
        </nav>

        <!-- ä»»åŠ¡ç®¡ç†é¡µé¢ -->
        <div v-if="currentView === 'tasks'" class="mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>APIä»»åŠ¡ç®¡ç†</h5>
                            <button class="btn btn-primary" @click="showAddTaskModal">æ·»åŠ ä»»åŠ¡</button>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ä»»åŠ¡åç§°</th>
                                        <th>URL</th>
                                        <th>æ–¹æ³•</th>
                                        <th>Cronè¡¨è¾¾å¼</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="task in tasks" :key="task.id">
                                        <td>{{ task.id }}</td>
                                        <td>{{ task.taskName }}</td>
                                        <td>{{ task.url }}</td>
                                        <td>{{ task.method }}</td>
                                        <td>{{ task.cronExpression }}</td>
                                        <td>
                                            <span :class="getStatusClass(task.status)">{{ task.status }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success" @click="startTask(task.id)" v-if="task.status === 'PAUSED'">å¯åŠ¨</button>
                                            <button class="btn btn-sm btn-warning" @click="pauseTask(task.id)" v-if="task.status === 'RUNNING'">æš‚åœ</button>
                                            <button class="btn btn-sm btn-info" @click="executeTask(task.id)">æ‰§è¡Œ</button>
                                            <button class="btn btn-sm btn-secondary" @click="editTask(task)">ç¼–è¾‘</button>
                                            <button class="btn btn-sm btn-danger" @click="deleteTask(task.id)">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰§è¡Œæ—¥å¿—é¡µé¢ -->
        <div v-if="currentView === 'logs'" class="mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>æ‰§è¡Œæ—¥å¿—</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ä»»åŠ¡ID</th>
                                        <th>è¯·æ±‚URL</th>
                                        <th>æ–¹æ³•</th>
                                        <th>å“åº”ç </th>
                                        <th>å“åº”æ—¶é—´(ms)</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ‰§è¡Œæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="log in logs" :key="log.id">
                                        <td>{{ log.id }}</td>
                                        <td>{{ log.taskId }}</td>
                                        <td>{{ log.requestUrl }}</td>
                                        <td>{{ log.requestMethod }}</td>
                                        <td>{{ log.responseCode }}</td>
                                        <td>{{ log.responseTime }}</td>
                                        <td>
                                            <span :class="getStatusClass(log.status)">{{ log.status }}</span>
                                        </td>
                                        <td>{{ formatDateTime(log.executeTime) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info" @click="viewLogDetail(log)">è¯¦æƒ…</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
        <div class="modal fade" id="taskModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ editingTask ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ·»åŠ ä»»åŠ¡' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">ä»»åŠ¡åç§°</label>
                                <input type="text" class="form-control" v-model="currentTask.taskName">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">URL</label>
                                <input type="text" class="form-control" v-model="currentTask.url">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æ–¹æ³•</label>
                                <select class="form-select" v-model="currentTask.method">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¶…æ—¶æ—¶é—´(ms)</label>
                                <input type="number" class="form-control" v-model="currentTask.timeout">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cronè¡¨è¾¾å¼</label>
                                <input type="text" class="form-control" v-model="currentTask.cronExpression" 
                                       placeholder="ä¾‹å¦‚: 0 */5 * * * ? (æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡)">
                                <div class="mt-2">
                                    <small class="text-muted">å¸¸ç”¨Cronè¡¨è¾¾å¼ç¤ºä¾‹ï¼š</small>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */1 * * * ?')">æ¯1åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */5 * * * ?')">æ¯5åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */10 * * * ?')">æ¯10åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 */30 * * * ?')">æ¯30åˆ†é’Ÿ</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 0 * * * ?')">æ¯å°æ—¶</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                                    @click="setCronExpression('0 0 */2 * * ?')">æ¯2å°æ—¶</button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 0 0 * * ?')">æ¯å¤©å‡Œæ™¨</button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 30 8 * * ?')">æ¯å¤©8:30</button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 0 9 * * MON')">æ¯å‘¨ä¸€9ç‚¹</button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1" 
                                                    @click="setCronExpression('0 0 1 * * ?')">æ¯æœˆ1å·</button>
                                            <button type="button" class="btn btn-sm btn-outline-info me-1 mb-1" 
                                                    @click="setCronExpression('0 0 9 ? * MON-FRI')">å·¥ä½œæ—¥9ç‚¹</button>
                                            <button type="button" class="btn btn-sm btn-outline-info me-1 mb-1" 
                                                    @click="setCronExpression('0 0 10 ? * SAT,SUN')">å‘¨æœ«10ç‚¹</button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">æ ¼å¼è¯´æ˜ï¼šç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨ [å¹´]</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Headers (JSONæ ¼å¼)</label>
                                <textarea class="form-control" v-model="currentTask.headers" rows="3"
                                          placeholder='{"Content-Type": "application/json"}'></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Parameters (JSONæ ¼å¼)</label>
                                <textarea class="form-control" v-model="currentTask.parameters" rows="3"
                                          placeholder='{"key": "value"}'></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" v-model="currentTask.description" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" @click="saveTask">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div class="modal fade" id="logDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ—¥å¿—è¯¦æƒ…</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="currentLog">
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚URL</label>
                                <input type="text" class="form-control" :value="currentLog.requestUrl" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚æ–¹æ³•</label>
                                <input type="text" class="form-control" :value="currentLog.requestMethod" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚Headers</label>
                                <textarea class="form-control" v-model="currentLog.requestHeaders" rows="3" readonly></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¯·æ±‚å‚æ•°</label>
                                <textarea class="form-control" v-model="currentLog.requestParams" rows="3" readonly></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å“åº”ç </label>
                                <input type="text" class="form-control" :value="currentLog.responseCode" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å“åº”ä½“</label>
                                <textarea class="form-control" v-model="currentLog.responseBody" rows="10" readonly></textarea>
                            </div>
                            <div v-if="currentLog.errorMessage" class="mb-3">
                                <label class="form-label">é”™è¯¯ä¿¡æ¯</label>
                                <textarea class="form-control" v-model="currentLog.errorMessage" rows="3" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentView: 'tasks',
                    tasks: [],
                    logs: [],
                    currentTask: {},
                    currentLog: {},
                    editingTask: false,
                    taskModal: null,
                    logDetailModal: null,
                    currentUser: ''
                };
            },
            mounted() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                this.checkAuth();
                
                this.taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                this.logDetailModal = new bootstrap.Modal(document.getElementById('logDetailModal'));
                this.loadTasks();
                this.loadLogs();
            },
            methods: {
                showTasks() {
                    this.currentView = 'tasks';
                },
                showLogs() {
                    this.currentView = 'logs';
                    this.loadLogs();
                },
                async loadTasks() {
                    try {
                        const response = await axios.get('/api/tasks');
                        this.tasks = response.data.data;
                    } catch (error) {
                        console.error('Failed to load tasks:', error);
                    }
                },
                async loadLogs() {
                    try {
                        const response = await axios.get('/api/responses');
                        this.logs = response.data.data;
                    } catch (error) {
                        console.error('Failed to load logs:', error);
                    }
                },
                showAddTaskModal() {
                    this.editingTask = false;
                    this.currentTask = {
                        taskName: '',
                        url: '',
                        method: 'GET',
                        timeout: 30000,
                        cronExpression: '',
                        headers: '',
                        parameters: '',
                        description: ''
                    };
                    this.taskModal.show();
                },
                editTask(task) {
                    this.editingTask = true;
                    this.currentTask = { ...task };
                    this.taskModal.show();
                },
                async saveTask() {
                    try {
                        if (this.editingTask) {
                            await axios.put(`/api/tasks/${this.currentTask.id}`, this.currentTask);
                        } else {
                            await axios.post('/api/tasks', this.currentTask);
                        }
                        this.taskModal.hide();
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to save task:', error);
                    }
                },
                async deleteTask(id) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                        try {
                            await axios.delete(`/api/tasks/${id}`);
                            this.loadTasks();
                        } catch (error) {
                            console.error('Failed to delete task:', error);
                        }
                    }
                },
                async startTask(id) {
                    try {
                        await axios.post(`/api/tasks/${id}/start`);
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to start task:', error);
                    }
                },
                async pauseTask(id) {
                    try {
                        await axios.post(`/api/tasks/${id}/pause`);
                        this.loadTasks();
                    } catch (error) {
                        console.error('Failed to pause task:', error);
                    }
                },
                async executeTask(id) {
                    try {
                        await axios.post(`/api/tasks/${id}/execute`);
                        alert('ä»»åŠ¡å·²æäº¤æ‰§è¡Œ');
                    } catch (error) {
                        console.error('Failed to execute task:', error);
                    }
                },
                viewLogDetail(log) {
                    this.currentLog = log;
                    this.logDetailModal.show();
                },
                getStatusClass(status) {
                    return {
                        'badge bg-success': status === 'RUNNING' || status === 'SUCCESS',
                        'badge bg-warning': status === 'PAUSED',
                        'badge bg-danger': status === 'ERROR'
                    };
                },
                formatDateTime(dateTime) {
                    if (!dateTime) return '';
                    return new Date(dateTime).toLocaleString();
                },
                setCronExpression(expression) {
                    this.currentTask.cronExpression = expression;
                },
                async checkAuth() {
                    try {
                        const response = await axios.get('/api/auth/check');
                        if (response.data.authenticated) {
                            this.currentUser = response.data.username;
                        } else {
                            window.location.href = '/login';
                        }
                    } catch (error) {
                        console.error('Auth check failed:', error);
                        window.location.href = '/login';
                    }
                },
                async logout() {
                    try {
                        await axios.post('/api/auth/logout');
                        window.location.href = '/login';
                    } catch (error) {
                        console.error('Logout failed:', error);
                        window.location.href = '/login';
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>